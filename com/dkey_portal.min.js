
function init(){delCookie("is_reminded"),Dkey_error_msg.g_ErrorInfo=dkey.g_ErrorInfo,""!=Dkey_error_msg.g_ErrorInfo&&errorInfo("checkErrorInfo",Dkey_error_msg.g_ErrorInfo),initEcAgent({success:function(a){var b=a.result;"1"===b?checkReloginBeforeCheck():"-1"===b?updateClientBeforeCheck():goInstallClient()},error:function(){goInstallClient()}})}function checkReloginBeforeCheck(){checkReLogin({notLogin:function(){updateClientBeforeCheck()}})}function updateClientBeforeCheck(){checkAndTestProxy({success:function(){checkUpdate("BEFORELOGIN",{success:function(){checkDkeyOK()}})}})}function ProDkeyV2(){EcAgent("doQueryService",["QUERY DKEY_DETECT"],{success:function(a){if(a&&a.result){var b=a.result;return b==DKEY_RETURN_CODE.RET_CERT_DKEY&&setCookie("UsingDkey","1"),b==DKEY_RETURN_CODE.RET_CERT_DKEY||b==DKEY_RETURN_CODE.RET_NO_KEY||b==DKEY_RETURN_CODE.RET_NO_DRIVER?(window.location="login_cert.csp",!1):(b!=DKEY_RETURN_CODE.RET_ND_DKEY&&errorInfo("checkErrorInfo",tr("验证错误")),setCookie("UsingDkey","1"),document.getElementById("errorInfo").innerHTML="",document.getElementById("table").style.display="",$ID("svpn_inputpin").focus(),v2orv3="v2",!0)}}})}function checkDkeyOK(){switch(dkey.g_DkeyType){case 0:window.location="login_cert.csp";break;case 1:ProDkeyV2();break;default:window.location="login_cert.csp"}}function checkv2(){EcAgent("doQueryService",["QUERY DKEY_DETECT"],{success:function(a){if(a&&a.result){var b=a.result;if(b!=DKEY_RETURN_CODE.RET_ND_DKEY)return errorInfo("checkErrorInfo",tr("验证错误")),!1;var c=mbStringLength(g_keypasswd);if(4>c||c>16)return errorInfo("checkErrorInfo",Dkey_error_msg.g_DkeyPinErr2),$ID("svpn_inputpin").focus(),!1;if(null!=g_user_pin_count&&0>=g_user_pin_count)return errorInfo("checkErrorInfo",Dkey_error_msg.g_DkeyLock),!1;var d=format("QUERY CHECK_PIN pin={0}&amp;randstring={1}",Base64.encode(g_keypasswd),dkey.g_RandString);EcAgent("doQueryService",[d],{success:function(a){if(a&&a.result){var b=a.result;if(-1==b.indexOf("UserName"))return g_user_pin_count=Number(b),g_user_pin_count>0?errorInfo("checkErrorInfo",tr("输入的PIN码错误,您还有{0}次机会",g_user_pin_count)):errorInfo("checkErrorInfo",Dkey_error_msg.g_DkeyLock),!1;b=urlToJson(b);var c=b.SerialNumber;setCookie("DkeySerialNumber",c),g_userName=unescape(b.UserName);var d=b.HMAC;$ID("username").value=g_userName,$ID("hmacmd5").value=d,setCookie("Usingnddkey","1v2"),$ID("form1").action="login_key.csp",$ID("form1").submit()}}})}}})}function checkInput(){g_keypasswd=$ID("svpn_inputpin").value,checkv2()}function errorInfo(a,b){var c=document.getElementById(a);c.style.display="block",c.style.color="red",c.innerHTML=b}function errorInfoHide(a){var b=document.getElementById(a);b.style.color="",b.style.display="none"}function urlToJson(a){if("object"==typeof a)return a;var b=a.split("&"),c={};return b.forEach(function(a){var b=a.indexOf("="),d=a.substring(0,b);c[d]=a.substring(b+1)}),c}DKEY_RETURN_CODE={RET_OK:0,RET_NO_KEY:1,RET_ND_DKEY:2,RET_CERT_DKEY:3,RET_WRONG_PIN:4,RET_KEY_LOCKED:5,RET_NO_DRIVER:6,RET_OTHER_ERROR:7},Dkey_error_msg={g_DkeyOpenErr:tr("打开USB-Key失败,可能USB-Key没插入"),g_DkeyReadErr:tr("读取文件信息失败"),g_DkeyHmacErr:tr("HMAC操作失败,请确认USB-Key是否完好"),g_DkeyPinErr2:tr("PIN码长度应该是4-16位,每个中文字符占两位!"),g_ErrorInfo:"",g_DkeyLock:tr("您已经超出最大密码重试次数,KEY被锁住"),g_ActiveNotInstall:tr("ActiveX不能正常运行,请检查控件是否已经下载,版本是否正确.")};var g_userName,timer=0,g_ActiveInstallSucess=!1,v2version=16777216,v3version="1.0.0.1",v2orv3="",g_keypasswd="",g_user_pin_count=null;addEvent($ID("svpn_inputpin"),"keypress",function(a){return a=a||window.event,"13"==(a.which||a.keyCode)?(checkInput(),!1):void 0});